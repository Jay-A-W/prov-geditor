<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jointjs/2.1.0/joint.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="css/editor.css">
</head>
<body>
    <!-- content -->
    <div id="prov-editor">
        <sidebar></sidebar>
        <namespace-modal></namespace-modal>
        <element-modal></element-modal>
        <div class="menu">
            <ul class="menu-options">
                <li class="menu-option option-wasGeneratedBy" onclick="addRelation('wasGeneratedBy')" hidden>wasGeneratedBy</li>
                <li class="menu-option option-wasDerivedFrom" onclick="addRelation('wasDerivedFrom')" hidden>wasDerivedFrom</li>
                <li class="menu-option option-wasAttributedTo" onclick="addRelation('wasAttributedTo')" hidden>wasAttributedTo</li>
                <li class="menu-option option-used" onclick="addRelation('used')" hidden>used</li>
                <li class="menu-option option-wasInformedBy" onclick="addRelation('wasInformedBy')" hidden>wasInformedBy</li>
                <li class="menu-option option-wasAssociatedWith" onclick="addRelation('wasAssociatedWith')" hidden>wasAssociatedWith</li>
                <li class="menu-option option-actedOnBehalfOf" onclick="addRelation('actedOnBehalfOf')" hidden>actedOnBehalfOf</li>
                
                <li class="menu-option option-wasInfluencedBy" onclick="addRelation('wasInfluencedBy')" hidden>wasInfluencedBy</li>
                <li class="menu-option option-hadPrimarySource" onclick="addRelation('hadPrimarySource')" hidden>hadPrimarySource</li>
                <li class="menu-option option-wasQuotedFrom" onclick="addRelation('wasQuotedFrom')" hidden>wasQuotedFrom</li>
                <li class="menu-option option-wasRevisionOf" onclick="addRelation('wasRevisionOf')" hidden>wasRevisionOf</li>
                <li class="menu-option option-wasInvalidatedBy" onclick="addRelation('wasInvalidatedBy')" hidden>wasInvalidatedBy</li>
                <li class="menu-option option-wasStartedBy" onclick="addRelation('wasStartedBy')" hidden>wasStartedBy</li>
                <li class="menu-option option-wasEndedBy" onclick="addRelation('wasEndedBy')" hidden>wasEndedBy</li>
            </ul>
        </div>
        <div id="graph"></div>
        <a href="#" onclick="show_doc_json(doc.scope);">exampleexample</a>
    </div>
    <!-- dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/vuex"></script>
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.3.3/backbone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jointjs/2.1.0/joint.js"></script>
    <script src="lib/customShapes/joint.shapes.custom.js"></script>
    <script type="text/javascript" src="lib/prov.js"></script>
    <script type="text/javascript" src="lib/api.js"></script>
    <script src="js/provFunc.js"></script>
    <script src="js/utlityFunctions.js"></script>
    <!-- Vue Declaration -->
    <script src="vue/sidebar.js"></script>
    <script src="vue/nameSpaceModal.js"></script>
    <script src="vue/elementModal.js"></script>
    <script src="vue/index.js"></script>
    

    <!-- code -->
    <script type="text/javascript">
        //CURRENTLY LINKING WITH REVISION, QUOTATION, PRIMARYSOURCE DOES NOT WORK AS API IS MISSING FUNC!!!
        let json = {};
        var graph = new joint.dia.Graph;

        var paper = new joint.dia.Paper({
            el: document.getElementById('graph'),
            model: graph,
            width: 2000,
            height: 2000,
            gridSize: 1,
            linkPinning: false,
            defaultLink: new joint.shapes.fsa.Arrow({
            }),
            elementView: joint.dia.ElementView.extend({
                pointerdblclick: function (evt, x, y) {
                    showModal();
                    store.commit("setCurrentElement", this);
                    //let input = prompt("Enter element name");
                    //let type = this.model.attributes.type.replace("custom.", "");
                    //let currentName = this.model.attributes.attrs.label.text;
                    //editPROVElement(type, currentName, input);
                    //this.model.attr('label/text', input);
                    //this.model.remove();
                }
            }),
            linkView: joint.dia.LinkView.extend({
     
            }),
        });

        const menu = document.querySelector(".menu");
        let menuVisible = false;

        const toggleMenu = command => {
            menu.style.display = command === "show" ? "block" : "none";
            menuVisible = !menuVisible;
        };

        const setPosition = ({ top, left }) => {
            menu.style.left = `${left}px`;
            menu.style.top = `${top}px`;
            toggleMenu('show');
        };

        function showModal(){
            $("#elementModal").show();
        };

        function addRelation(label){
            store.commit("setCurrentLinkLabel", label);
            doc[label]("ex:"+store.state.currentSource.id, "ex:"+store.state.currentTarget.id);
            for (let child of $(".menu-options").children()){
                child.style.display = "none";
            }
            toggleMenu('hide');
        };

        function hideContextOptions(source, target){
            let menuOptions = document.querySelector(".menu-options");
   
            let sourceType = source.attributes.type;
            let targetType = target.attributes.type;

            let entity2Entity = ['wasDerivedFrom', 'wasInfluencedBy', 'hadPrimarySource', 'wasQuotedFrom', 'wasRevisionOf'];
            let entity2Activity = ['wasGeneratedBy', 'wasInfluencedBy', 'wasInvalidatedBy'];
            let entity2Agent = ['wasAttributedTo', 'wasInfluencedBy'];
            let activity2Activity = ['wasInformedBy', 'wasInfluencedBy'];
            let activity2Entity = ['used', 'wasInfluencedBy', 'wasStartedBy', 'wasEndedBy'];
            let activity2Agent = ['wasAssociatedWith', 'wasInfluencedBy'];
            let agent2Agent = ['actedOnBehalfOf', 'wasInfluencedBy'];
            let agent2Entity = ['wasInfluencedBy'];
            let agent2Activity = ['wasInfluencedBy'];
            
            let validOptions;
            if (sourceType == 'custom.Entity'){
                switch (targetType){
                    case 'custom.Entity':
                        validOptions = entity2Entity;
                        break;
                    case 'custom.Activity':
                        validOptions = entity2Activity;
                        break;
                    case 'custom.Agent':
                        validOptions = entity2Agent;
                        break;
                }
            } else if (sourceType == 'custom.Activity'){
                switch (targetType){
                    case 'custom.Entity':
                        validOptions = activity2Entity;
                        break;
                    case 'custom.Activity':
                        validOptions = activity2Activity;
                        break;
                    case 'custom.Agent':
                        validOptions = activity2Agent;
                        break;
                }
            } else if (sourceType == 'custom.Agent'){
                switch (targetType){
                    case 'custom.Entity':
                        validOptions = agent2Entity;
                        break;
                    case 'custom.Activity':
                        validOptions = agent2Activity;
                        break;
                    case 'custom.Agent':
                        validOptions = agent2Agent;
                        break;
                }
            }
            for (let option of validOptions){
                $(".option-"+option).show();
            }
        };

        function getElementById(id){
            for (let element of graph.getElements()){
                if (element.id === id){
                    return element;
                }
            }
        };

        //On connection
        graph.on('change:source change:target', function (link) {
            let source = link.get('source');
            let target = link.get('target');
            if (source.id && target.id) {
                // both ends of the link are connected.
                const origin = {
                    left: event.clientX,
                    top: event.clientY
                };
                setPosition(origin);
                let sourceElement = getElementById(source.id);
                let targetElement = getElementById(target.id);
                
                hideContextOptions(sourceElement, targetElement);
                store.commit("setCurrentSource", source);
                store.commit("setCurrentTarget", target);
                store.commit("setCurrentLink", link);
                return false;
            }
        })

        graph.on('remove', function(cell, cellView, evt) {
            if (cell.isLink()) {
                // a link was removed  (cell.id contains the ID of the removed link)
                console.log(cell);
                console.log(doc.scope.statements.filter);
                //REMEMBER NEED TO REMOVE LINK FROM DOC BY PRESSING X BUTTON ON LINK (TO BE DONE)
                //let type = model.attributes.type.replace("custom.", "");
                //let currentName = model.attributes.attrs.label.text;
                //let provElement = doc.scope.statements.filter(elementType => elementType.constructor.name == type).filter(element => element.identifier.localPart == currentName);
                //let filtered = doc.scope.statements.filter(function (element) {
                //    if ((element.constructor.name == type) && (element.identifier.localPart == currentName)) {
                //        return false;
                //    } else {
                //        return true;
                //    }
                //});
                //doc.scope.statements = filtered;
                //model.remove();

            }
        })
    
        paper.on('delete:button:pointerdown', function (elementView, evt) {
            evt.stopPropagation(); // stop any further actions with the element view (e.g. dragging)
            let model = elementView.model;
            let type = model.attributes.type.replace("custom.", "");
            let currentName = model.attributes.attrs.label.text;
            let provElement = doc.scope.statements.filter(elementType => elementType.constructor.name == type).filter(element => element.identifier.localPart == currentName);
            let filtered = doc.scope.statements.filter(function (element) {
                if ((element.constructor.name == type) && (element.identifier.localPart == currentName)) {
                    return false;
                } else {
                    return true;
                }
            });
            doc.scope.statements = filtered;
            model.remove();
        });

        function link(source, target, label, vertices) {
            //doc.used("ex:" + source.id, "ex:" + target.id);
            //doc['used']("ex:" + source.id, "ex:" + target.id);
            let labelFunc = doc[label];

            //console.log(typeof labelFunc !== 'function');
            if (typeof labelFunc !== 'function') {
                throw new Error('invalid label type '+label);
            } else {
                var cell = new joint.shapes.fsa.Arrow({
                    source: { id: source.id },
                    target: { id: target.id },
                    labels: [{ position: .5, attrs: { text: { text: label || '', 'font-weight': 'bold' } } }],
                    vertices: vertices || []
                });
                graph.addCell(cell);
                console.log(source);
                doc[label]("ex:"+source.attributes.attrs.label.text, "ex:"+target.attributes.attrs.label.text);
                return cell;
            }
        }

        let doc = prov.document();
        store.commit("addPrefixToSet", 'xsd');
        store.commit("addPrefixToSet", 'prov');
        var def = doc.setDefaultNamespace("http://default.example.com/");
        store.commit("addPrefixToSet", 'def');
        var ex = doc.addNamespace("ex", "http://www.example.org/");
        store.commit("addPrefixToSet", 'ex');

        function createElement(type,name,prefix,x,y) {
            let item;
            switch (type) {

                case 'entity':
                    item = new joint.shapes.custom.Entity();
                    item.attr('label/text', name);
                    item.attr('prefix', prefix);
                    let entity = doc.entity(prefix + ":" + name);
                    break;

                case 'activity':
                    item = new joint.shapes.custom.Activity();
                    item.attr('label/text', name);
                    item.attr('prefix', prefix);
                    let activity = doc.activity(prefix + ":" + name);
                    break;

                case 'agent':
                    item = new joint.shapes.custom.Agent();
                    item.attr('label/text', name);
                    item.attr('prefix', prefix);
                    let agent = doc.agent(prefix + ":" + name);
                    break;
                default:
                    throw new Error('Invalid item type');
            }
            item.resize(100, 40);

            if ((x != null) && (y != null)) {
                item.position(x, y);
            }
            item.addTo(graph);
            return item;
        }

        function createElementNoPROV(type,x,y) {
            let item;
            switch (type) {
                case 'entity':
                    item = new joint.shapes.custom.Entity();
                    item.attr('label/text', type);
                    break;

                case 'activity':
                    item = new joint.shapes.custom.Activity();
                    item.attr('label/text', type);
                    break;

                case 'agent':
                    item = new joint.shapes.custom.Agent();
                    item.attr('label/text', type);
                    break;
                default:
                    throw new Error('Invalid item type');
            }
            item.resize(100, 40);

            if ((x != null) && (y != null)) {
                item.position(x, y);
            }
            item.addTo(graph);
            return item;
        }

        let activity = createElement('activity','writing','ex', 400, 500);
        let entity = createElement('entity', 'story', 'ex', 400, 230);
        let agent = createElement('agent', 'writer', 'ex', 100, 330);

        var used = link(activity, entity, 'used', [{ x: 400, y: 400 }]);
        var wasGeneratedBy = link(entity, activity, 'wasGeneratedBy', [{ x: 500, y: 400 }]);
        var wasDerivedFrom = link(entity, entity, 'wasDerivedFrom', [{ x: 400, y: 150 }, { x: 500, y: 150 }]);
        var wasAttributedTo = link(entity, agent, 'wasAttributedTo');
        var wasAssociatedWith = link(activity, agent, 'wasAssociatedWith');

        window.onload = function () {
            document.getElementById("graph").addEventListener("click", function () {
                //console.log(event.clientX + "x" + event.clientY + "y");
                if(menuVisible)toggleMenu("hide"); //For context menu
                let activeTool = store.state.activeTool;
                let pointX = event.clientX-25;
                let pointY = event.clientY - 25;
                if (activeTool != "none") {
                    createElementNoPROV(activeTool, pointX, pointY); //Create element with no PROV information
                }
                store.commit('setActiveTool', 'none');
                event.stopPropagation();
            });
        }

        function example() {
            //var e1 = prov.entity("ex:e1");
            //e1.attr("ex:foo", ex.qn("bar"))
            //    .attr("ex:baz", ["abc", "xsd:string"])
            //    .attr("ex:bah", ["1", "xsd:integer"])
            //    .attr("ex:bam", ["bam", undefined, "en"])
            //    .attr(ex.qn("bam"), prov.literal("bam", undefined, "en"));
            //console.log(e1);
            //var d_e1 = prov.entity("d_e1");
            //var e2 = prov.entity("ex:e2")
            //    .attr("ex:dat", new Date(Date.now()))
            //    .attr("ex:int", 1)
            //    .attr("ex:nint", -1)
            //    .attr("ex:flt", 1.02)
            //    .attr("ex:str", "def")
            //    .attr("ex:bool", true);
            //console.log(e2);

            //var der1 = prov.wasDerivedFrom("ex:e2", "ex:e1")
            //    .attr("prov:type", ["prov:Revision", "xsd:QName"])
            //    .id(ex.qn('d1'));
            //var der1 = prov.wasDerivedFrom("ex:e2", "ex:e1");
            //der1.attr(prov.ns.qn("type"), prov.ns.qn("Revision"));
            //der1.id(ex.qn('d1'));
            ////der1.activity = ex.qn('a1');
            //der1.attr(prov.ns.qn("type"), prov.ns.qn("Revision"));
            //console.log(der1);

            //var der2 = prov.wasDerivedFrom("ex:e2", "ex:e1", ["prov:type", prov.ns.qn("Revision")]);
            //console.log(der2);
            //var bundle = prov.bundle("ex:bundle");
            //bundle.entity("ex:e2").attr("prov:type", ["prov:Revision", "xsd:QName"]);
            //var bundle2 = prov.bundle("ex:bundle2");
            //console.log(bundle);
            // var doc = prov.document().document();
            // doc.entity("ex:foo");
            // console.log(doc);
            //prov.wasDerivedFrom("ex:e2", "ex:e1").generatedEntity("ex:e4");
            //show_doc_json(prov.scope);
        }

    </script>
</body>
</html>